---
name: Aave去中心化改造方案
overview: 改造 Aave V3 协议，实现：1) 限制流动性提供者仅为机构白名单地址；2) 使用 Timelock + 多签实现去中心化管理，移除单一管理员权限；3) 保留用户借贷功能。
todos:
  - id: modify-pool-storage
    content: 在 PoolStorage.sol 中添加流动性提供者白名单存储（_liquidityProviderWhitelist mapping 和 _whitelistAdmin）
    status: completed
  - id: modify-pool-supply
    content: 在 Pool.sol 中添加 onlyLiquidityProvider 修饰符，修改 supply() 和 supplyWithPermit() 函数添加白名单检查
    status: completed
    dependencies:
      - modify-pool-storage
  - id: add-whitelist-management
    content: 在 Pool.sol 中添加 addLiquidityProvider() 和 removeLiquidityProvider() 函数（仅 PoolAdmin 可调用）
    status: completed
    dependencies:
      - modify-pool-supply
  - id: modify-pool-addresses-provider
    content: 在 PoolAddressesProvider.sol 中添加 Timelock 支持，修改关键配置函数为 onlyTimelock
    status: completed
  - id: modify-acl-manager
    content: 在 ACLManager.sol 中添加 Timelock 支持，修改所有角色管理函数为 onlyTimelock
    status: completed
  - id: add-errors-events
    content: 在 Errors.sol 中添加新错误定义，在 IPool.sol 中添加白名单相关事件
    status: completed
  - id: create-timelock-contract
    content: 创建或集成 Timelock 合约（使用 OpenZeppelin TimelockController 或自定义实现）
    status: completed
  - id: create-deployment-script
    content: 创建部署脚本 scripts/deploy-decentralized.s.sol，包含多签钱包、Timelock 和协议合约的部署流程
    status: completed
    dependencies:
      - create-timelock-contract
  - id: write-unit-tests
    content: 编写单元测试，测试白名单功能、权限检查和 Timelock 集成
    status: completed
    dependencies:
      - modify-pool-supply
      - modify-pool-addresses-provider
      - modify-acl-manager
  - id: write-integration-tests
    content: 编写集成测试，测试完整部署流程、多签操作和端到端功能
    status: completed
    dependencies:
      - create-deployment-script
      - write-unit-tests
---

# Aave 去中心化改造方案

## 改造目标

1. **限制流动性提供者**：只有机构白名单地址可以调用 `supply()` 函数
2. **去中心化管理**：使用 Timelock + 多签钱包（Gnosis Safe）替代单一 owner，实现去中心化治理
3. **保留借贷功能**：普通用户仍可从资金池借款

## 架构设计

### 权限管理架构

```
Gnosis Safe (多签钱包)
    ↓ (执行者)
Timelock (时间锁)
    ↓ (owner/admin)
PoolAddressesProvider / ACLManager
    ↓
Pool / PoolConfigurator
```

### 流动性提供限制

- 添加白名单机制，只有机构地址可以调用 `supply()`
- 白名单管理通过 Timelock 控制
- 普通用户仍可调用 `borrow()`、`repay()`、`withdraw()`（仅限自己存入的部分）

## 改造内容

### 1. 添加流动性提供者白名单机制

#### 1.1 修改 PoolStorage.sol

在 `PoolStorage` 中添加白名单存储：

```solidity
// 流动性提供者白名单
mapping(address => bool) internal _liquidityProviderWhitelist;
// 白名单管理员（应设置为 Timelock 地址）
address internal _whitelistAdmin;
```

#### 1.2 修改 Pool.sol

在 `Pool.sol` 中：

1. **添加白名单检查修饰符**：
```solidity
modifier onlyLiquidityProvider() {
    require(_liquidityProviderWhitelist[_msgSender()], Errors.CallerNotLiquidityProvider());
    _;
}
```

2. **修改 supply() 函数**：
```solidity
function supply(
    address asset,
    uint256 amount,
    address onBehalfOf,
    uint16 referralCode
) public virtual override onlyLiquidityProvider {
    // ... 现有逻辑保持不变
}
```

3. **添加白名单管理函数**（仅 Timelock 可调用）：
```solidity
function addLiquidityProvider(address provider) external onlyPoolAdmin {
    _liquidityProviderWhitelist[provider] = true;
    emit LiquidityProviderAdded(provider);
}

function removeLiquidityProvider(address provider) external onlyPoolAdmin {
    _liquidityProviderWhitelist[provider] = false;
    emit LiquidityProviderRemoved(provider);
}
```


#### 1.3 修改 IPool.sol 接口

添加新的事件定义：

```solidity
event LiquidityProviderAdded(address indexed provider);
event LiquidityProviderRemoved(address indexed provider);
```

### 2. 去中心化权限管理改造

#### 2.1 修改 PoolAddressesProvider.sol

**文件位置**：`src/contracts/protocol/configuration/PoolAddressesProvider.sol`

1. **添加 Timelock 验证**：
```solidity
// 添加 Timelock 地址存储
address private _timelock;

modifier onlyTimelock() {
    require(_msgSender() == _timelock, Errors.CallerNotTimelock());
    _;
}

function setTimelock(address timelock) external onlyOwner {
    require(timelock != address(0), Errors.ZeroAddressNotValid());
    _timelock = timelock;
    emit TimelockUpdated(timelock);
}
```

2. **修改关键函数为 onlyTimelock**：

   - `setPoolImpl()` → `onlyTimelock`
   - `setPoolConfiguratorImpl()` → `onlyTimelock`
   - `setPriceOracle()` → `onlyTimelock`
   - `setACLManager()` → `onlyTimelock`
   - `setACLAdmin()` → `onlyTimelock`

**注意**：部署后需要立即将 `owner` 转移给 Timelock 地址。

#### 2.2 修改 ACLManager.sol

**文件位置**：`src/contracts/protocol/configuration/ACLManager.sol`

1. **添加 Timelock 验证**：
```solidity
address private _timelock;

modifier onlyTimelock() {
    require(_msgSender() == _timelock, Errors.CallerNotTimelock());
    _;
}

function setTimelock(address timelock) external onlyRole(DEFAULT_ADMIN_ROLE) {
    require(timelock != address(0), Errors.ZeroAddressNotValid());
    _timelock = timelock;
    emit TimelockUpdated(timelock);
}
```

2. **修改角色管理函数**：

   - `addPoolAdmin()` → `onlyTimelock`
   - `removePoolAdmin()` → `onlyTimelock`
   - `addEmergencyAdmin()` → `onlyTimelock`
   - `removeEmergencyAdmin()` → `onlyTimelock`
   - 其他角色管理函数同样修改

#### 2.3 添加错误定义

在 `Errors.sol` 中添加：

```solidity
string public constant CallerNotTimelock = '1'; // 'The caller of the function is not the timelock'
string public constant CallerNotLiquidityProvider = '2'; // 'The caller is not a whitelisted liquidity provider'
```

### 3. 部署和初始化流程

#### 3.1 部署顺序

1. 部署 Gnosis Safe 多签钱包（至少 3 个签名者）
2. 部署 Timelock 合约（执行者设置为 Gnosis Safe）
3. 部署 PoolAddressesProvider（owner 设置为部署者地址）
4. 部署 ACLManager
5. 部署 Pool 和 PoolConfigurator
6. **关键步骤**：将 PoolAddressesProvider 的 owner 转移给 Timelock
7. 在 ACLManager 中设置 Timelock 地址
8. 在 Pool 中添加初始流动性提供者白名单

#### 3.2 初始化脚本

创建部署脚本 `scripts/deploy-decentralized.s.sol`，包含：

- 多签钱包创建
- Timelock 部署和配置
- 协议合约部署
- 权限转移
- 白名单初始化

## 关键文件修改清单

### 核心合约修改

1. **PoolStorage.sol**

   - 添加 `_liquidityProviderWhitelist` mapping
   - 添加 `_whitelistAdmin` 地址

2. **Pool.sol**

   - 添加 `onlyLiquidityProvider` 修饰符
   - 修改 `supply()` 和 `supplyWithPermit()` 添加白名单检查
   - 添加 `addLiquidityProvider()` 和 `removeLiquidityProvider()` 函数

3. **PoolAddressesProvider.sol**

   - 添加 `_timelock` 地址存储
   - 添加 `onlyTimelock` 修饰符
   - 修改所有关键配置函数为 `onlyTimelock`

4. **ACLManager.sol**

   - 添加 `_timelock` 地址存储
   - 添加 `onlyTimelock` 修饰符
   - 修改所有角色管理函数为 `onlyTimelock`

5. **Errors.sol**

   - 添加 `CallerNotTimelock` 错误
   - 添加 `CallerNotLiquidityProvider` 错误

6. **IPool.sol**

   - 添加 `LiquidityProviderAdded` 和 `LiquidityProviderRemoved` 事件

### 新增文件

1. **Timelock 合约**：使用 OpenZeppelin 的 TimelockController 或自定义实现
2. **部署脚本**：`scripts/deploy-decentralized.s.sol`
3. **测试文件**：`tests/protocol/decentralized/DecentralizedPool.t.sol`

## 安全考虑

1. **权限分离**：

   - 多签钱包控制 Timelock 执行
   - Timelock 控制协议配置
   - 白名单控制流动性提供

2. **时间延迟**：

   - 所有管理员操作需要 Timelock 延迟（建议 24-48 小时）
   - 紧急操作可以通过 EmergencyAdmin 角色（也需要多签）

3. **白名单管理**：

   - 只有通过 Timelock 才能添加/移除流动性提供者
   - 建议定期审查白名单

4. **升级安全**：

   - 合约升级需要通过 Timelock 批准
   - 使用代理模式保持地址不变

## 测试要求

1. **单元测试**：

   - 白名单功能测试
   - 权限检查测试
   - Timelock 集成测试

2. **集成测试**：

   - 完整部署流程测试
   - 多签钱包操作测试
   - 端到端流动性提供和借贷测试

3. **安全测试**：

   - 权限绕过测试
   - 重入攻击测试
   - 时间锁绕过测试

## 实施步骤

### 阶段 1：核心功能改造（1-2 周）

- [ ] 修改 PoolStorage 添加白名单存储
- [ ] 修改 Pool.sol 添加白名单检查
- [ ] 修改 PoolAddressesProvider 添加 Timelock 支持
- [ ] 修改 ACLManager 添加 Timelock 支持
- [ ] 添加错误定义和事件

### 阶段 2：部署和测试（1 周）

- [ ] 编写部署脚本
- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 本地测试环境验证

### 阶段 3：审计和优化（1-2 周）

- [ ] 代码审查
- [ ] 安全审计
- [ ] Gas 优化
- [ ] 文档完善

### 阶段 4：主网部署（1 周）

- [ ] 部署多签钱包
- [ ] 部署 Timelock
- [ ] 部署协议合约
- [ ] 权限转移和初始化
- [ ] 验证和监控