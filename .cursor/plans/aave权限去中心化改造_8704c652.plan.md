---
name: Aave权限去中心化改造
overview: 将 Aave V3 协议从单一机构管理模式改造为去中心化管理，通过 Timelock + Gnosis Safe 多签实现分层权限控制，限制流动性提供者为白名单机构，保留普通用户借贷功能。
todos:
  - id: add-whitelist-storage
    content: 在 PoolStorage.sol 中添加流动性提供者白名单 mapping 和相关存储
    status: pending
  - id: modify-pool-supply
    content: 在 Pool.sol 中添加 onlyLiquidityProvider 修饰符，修改 supply() 和 supplyWithPermit()
    status: pending
    dependencies:
      - add-whitelist-storage
  - id: add-whitelist-management
    content: 在 Pool.sol 中添加 addLiquidityProvider() 和 removeLiquidityProvider() 函数
    status: pending
    dependencies:
      - modify-pool-supply
  - id: create-multisig-adapter
    content: 创建 MultisigRoleAdapter.sol 实现多签钱包与角色的映射
    status: pending
  - id: modify-acl-manager
    content: 修改 ACLManager.sol 集成多签适配器，修改角色管理函数权限检查
    status: pending
    dependencies:
      - create-multisig-adapter
  - id: modify-addresses-provider
    content: 修改 PoolAddressesProvider.sol 添加 Timelock 支持
    status: pending
  - id: add-errors-events
    content: 在 Errors.sol 和 IPool.sol 中添加新错误和事件定义
    status: pending
  - id: create-deployment-script
    content: 创建去中心化部署脚本 DeployDecentralized.s.sol
    status: pending
    dependencies:
      - modify-acl-manager
      - modify-addresses-provider
  - id: write-tests
    content: 编写白名单、Timelock 和多签集成测试
    status: pending
    dependencies:
      - add-whitelist-management
      - modify-acl-manager
---

# Aave 协议权限去中心化改造方案

## 当前架构分析

当前 Aave V3 权限架构如下：

```mermaid
flowchart TB
    subgraph currentArch [当前架构: 单一机构控制]
        Owner[单一 Owner 地址]
        Owner --> PAP[PoolAddressesProvider]
        ACLAdmin[ACL Admin] --> ACL[ACLManager]
        ACL --> PoolAdmin[POOL_ADMIN_ROLE]
        ACL --> RiskAdmin[RISK_ADMIN_ROLE]
        ACL --> EmergencyAdmin[EMERGENCY_ADMIN_ROLE]
    end
    
    PAP --> Pool[Pool 合约]
    PAP --> PC[PoolConfigurator]
```

**关键权限点**：

1. [`PoolAddressesProvider.sol`](src/contracts/protocol/configuration/PoolAddressesProvider.sol) - 继承 `Ownable`，所有关键函数使用 `onlyOwner` 修饰符
2. [`ACLManager.sol`](src/contracts/protocol/configuration/ACLManager.sol) - 基于 OpenZeppelin `AccessControl`，`DEFAULT_ADMIN_ROLE` 拥有最高权限
3. [`Pool.sol`](src/contracts/protocol/pool/Pool.sol) - `supply()` 函数无限制，任何人都可以提供流动性

## 目标架构设计

```mermaid
flowchart TB
    subgraph topLayer [顶层: 主权层]
        TopSafe[Gnosis Safe 4-of-5]
        Timelock[TimelockController 7天延迟]
        TopSafe -->|提案| Timelock
    end
    
    subgraph midLayer [中层: 运营层]
        MidSafe[Gnosis Safe 3-of-5]
    end
    
    subgraph bottomLayer [底层: 熔断层]
        EmergSafe[Gnosis Safe 2-of-3]
    end
    
    Timelock --> PAP[PoolAddressesProvider]
    Timelock --> ACL[ACLManager]
    MidSafe --> ACL
    EmergSafe --> ACL
    
    ACL --> Pool[Pool]
    Pool --> Whitelist[流动性提供者白名单]
```



## 核心改造内容

### 1. 流动性提供者白名单机制

**修改文件**:

- [`src/contracts/protocol/pool/PoolStorage.sol`](src/contracts/protocol/pool/PoolStorage.sol)
- [`src/contracts/protocol/pool/Pool.sol`](src/contracts/protocol/pool/Pool.sol)
- [`src/contracts/interfaces/IPool.sol`](src/contracts/interfaces/IPool.sol)
```solidity
// PoolStorage.sol - 添加白名单存储
mapping(address => bool) internal _liquidityProviderWhitelist;

// Pool.sol - 添加修饰符和管理函数
modifier onlyLiquidityProvider() {
    require(_liquidityProviderWhitelist[msg.sender], Errors.CallerNotLiquidityProvider());
    _;
}

function supply(...) public virtual override onlyLiquidityProvider { ... }
function addLiquidityProvider(address provider) external onlyPoolAdmin { ... }
function removeLiquidityProvider(address provider) external onlyPoolAdmin { ... }
```




### 2. Timelock 集成

**新增文件**:

- `src/contracts/protocol/configuration/TimelockRoleManager.sol`

**修改文件**:

- [`src/contracts/protocol/configuration/PoolAddressesProvider.sol`](src/contracts/protocol/configuration/PoolAddressesProvider.sol) - 关键配置函数改为 `onlyTimelock`
- [`src/contracts/protocol/configuration/ACLManager.sol`](src/contracts/protocol/configuration/ACLManager.sol) - 角色管理函数改为 `onlyTimelock`

### 3. 多签钱包适配器

**新增文件**:

- `src/contracts/protocol/configuration/MultisigRoleAdapter.sol`
- `src/contracts/interfaces/IMultisigRoleAdapter.sol`

用于将 Gnosis Safe 多签钱包地址映射到 Aave 角色，实现"合约嵌套"式的去中心化控制。

### 4. 错误和事件定义

**修改文件**:

- [`src/contracts/protocol/libraries/helpers/Errors.sol`](src/contracts/protocol/libraries/helpers/Errors.sol)
```solidity
error CallerNotTimelock();
error CallerNotLiquidityProvider();
```




## 三层权限配置

| 层级 | 角色 | 多签配置 | Timelock | 操作范围 ||------|------|----------|----------|----------|| 顶层 | DEFAULT_ADMIN_ROLE | 4-of-5 | 7天 | 合约升级、预言机更换、管理员增删 || 中层 | POOL_ADMIN/RISK_ADMIN | 3-of-5 | 无 | 利率调整、LTV配置、借贷上限 || 底层 | EMERGENCY_ADMIN | 2-of-3 | 无 | 紧急暂停、熔断操作 |

## 部署流程

1. 部署 3 个 Gnosis Safe 多签钱包（顶层、中层、底层）
2. 部署 OpenZeppelin TimelockController（minDelay: 7天）
3. 部署 MultisigRoleAdapter
4. 升级 ACLManager 集成多签适配器
5. 将 PoolAddressesProvider 的 owner 转移给 Timelock
6. 配置初始流动性提供者白名单

## 文件修改清单

### 核心合约修改

1. `src/contracts/protocol/pool/PoolStorage.sol` - 添加白名单存储
2. `src/contracts/protocol/pool/Pool.sol` - 添加白名单检查和管理
3. `src/contracts/protocol/configuration/PoolAddressesProvider.sol` - Timelock 集成
4. `src/contracts/protocol/configuration/ACLManager.sol` - 多签适配器集成
5. `src/contracts/protocol/libraries/helpers/Errors.sol` - 新增错误定义

### 新增文件