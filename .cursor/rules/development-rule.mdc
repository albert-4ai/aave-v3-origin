---
description: Aave V3.5 é¡¹ç›®å¼€å‘è§„èŒƒ - ä»£ç é£æ ¼ã€å®‰å…¨å®è·µã€ä»£ç é£æ ¼ã€æµ‹è¯•è¦æ±‚å’Œå›¢é˜Ÿåä½œè§„èŒƒ
alwaysApply: false
---
# Aave V3.5 é¡¹ç›®å¼€å‘è§„èŒƒ

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒé…ç½®
- **Solidity ç‰ˆæœ¬**: `^0.8.10` æˆ– `^0.8.27`ï¼ˆæ ¹æ®åˆçº¦è€Œå®šï¼‰
- **EVM ç‰ˆæœ¬**: `shanghai` (é»˜è®¤), `cancun` (zksync), `london` (linea)
- **ç¼–è¯‘å™¨ä¼˜åŒ–**: 200 runs
- **æ¡†æ¶**: Foundry (forge, cast, anvil)
- **è®¸å¯è¯**: `BUSL-1.1` (æ ¸å¿ƒåˆçº¦) æˆ– `MIT` (å·¥å…·åˆçº¦)

### å¼€å‘å·¥å…·
- **ä»£ç æ ¼å¼åŒ–**: `forge fmt`
- **æµ‹è¯•æ¡†æ¶**: Foundry Test
- **æ¨¡ç³Šæµ‹è¯•**: Foundry Fuzzing (é»˜è®¤ 1000 runs)
- **ä¸å˜æ€§æµ‹è¯•**: Foundry Invariant Testing

---

## ğŸ“ Solidity ä»£ç è§„èŒƒ

### æ–‡ä»¶å¤´éƒ¨
```solidity
// SPDX-License-Identifier: BUSL-1.1  // æˆ– MIT
pragma solidity ^0.8.10;  // æˆ– ^0.8.27
```

### å¯¼å…¥é¡ºåº
1. OpenZeppelin åˆçº¦
2. é¡¹ç›®ä¾èµ– (`dependencies/`)
3. é¡¹ç›®æ¥å£ (`interfaces/`)
4. é¡¹ç›®åº“ (`libraries/`)
5. é¡¹ç›®å·¥å…· (`helpers/`, `misc/`)
6. é¡¹ç›®ç±»å‹å®šä¹‰ (`types/`)

```solidity
// 1. OpenZeppelin
import {Context} from 'openzeppelin-contracts/contracts/utils/Context.sol';
import {IERC20} from 'openzeppelin-contracts/contracts/token/ERC20/IERC20.sol';

// 2. é¡¹ç›®ä¾èµ–
import {GPv2SafeERC20} from '../../../dependencies/gnosis/contracts/GPv2SafeERC20.sol';

// 3. é¡¹ç›®æ¥å£
import {IPool} from '../../../interfaces/IPool.sol';
import {IAToken} from '../../../interfaces/IAToken.sol';

// 4. é¡¹ç›®åº“
import {Errors} from '../helpers/Errors.sol';
import {ReserveLogic} from './ReserveLogic.sol';
import {DataTypes} from '../types/DataTypes.sol';
```

### å‘½åçº¦å®š

#### åˆçº¦å’Œæ¥å£
- **åˆçº¦**: `PascalCase` (å¦‚ `Pool`, `PoolStorage`, `SupplyLogic`)
- **æ¥å£**: `I` + `PascalCase` (å¦‚ `IPool`, `IAToken`, `IACLManager`)
- **æŠ½è±¡åˆçº¦**: `PascalCase` + `Base` åç¼€ (å¦‚ `DebtTokenBase`, `IncentivizedERC20`)
- **åº“åˆçº¦**: `PascalCase` + `Logic` æˆ– `Math` åç¼€ (å¦‚ `SupplyLogic`, `WadRayMath`)

#### å˜é‡å’Œå‡½æ•°
- **çŠ¶æ€å˜é‡**: `camelCase`ï¼Œç§æœ‰å˜é‡åŠ ä¸‹åˆ’çº¿å‰ç¼€ (å¦‚ `_reserves`, `_userState`)
- **å‡½æ•°**: `camelCase` (å¦‚ `supply`, `withdraw`, `executeSupply`)
- **å¸¸é‡**: `UPPER_SNAKE_CASE` (å¦‚ `UMBRELLA`, `DELEGATION_WITH_SIG_TYPEHASH`)
- **ä¸å¯å˜å˜é‡**: `UPPER_SNAKE_CASE` (å¦‚ `ADDRESSES_PROVIDER`, `POOL`)

#### äº‹ä»¶å’Œé”™è¯¯
- **äº‹ä»¶**: `PascalCase`ï¼ŒåŠ¨è¯å¼€å¤´ (å¦‚ `Supply`, `Borrow`, `Repay`, `LiquidationCall`)
- **é”™è¯¯**: ä½¿ç”¨ `Errors` åº“ä¸­çš„é”™è¯¯ï¼Œæˆ–è‡ªå®šä¹‰ `error` (å¦‚ `ERC20InsufficientAllowance`)

### å¯è§æ€§å’Œæ•°æ®ä½ç½®
- **å‡½æ•°å¯è§æ€§**: æ˜ç¡®æ ‡æ³¨ `public`, `external`, `internal`, `private`
  - `external`: ä»…å¤–éƒ¨è°ƒç”¨ï¼ˆGas ä¼˜åŒ–ï¼‰
  - `public`: æ”¯æŒå†…éƒ¨å’Œå¤–éƒ¨è°ƒç”¨
  - `internal`: å†…éƒ¨å’Œç»§æ‰¿åˆçº¦è°ƒç”¨
  - `private`: ä»…å½“å‰åˆçº¦è°ƒç”¨
- **æ•°æ®ä½ç½®**: æ˜ç¡®ä½¿ç”¨ `memory`, `storage`, `calldata`
  - `calldata`: å¤–éƒ¨å‡½æ•°å‚æ•°ï¼ˆåªè¯»ï¼ŒGas æœ€ä¼˜ï¼‰
  - `memory`: ä¸´æ—¶æ•°æ®
  - `storage`: æŒä¹…åŒ–å­˜å‚¨å¼•ç”¨

### åˆçº¦ç»“æ„é¡ºåº
```solidity
contract ExampleContract {
    // 1. ä½¿ç”¨å£°æ˜
    using ReserveLogic for DataTypes.ReserveData;
    using GPv2SafeERC20 for IERC20;
    
    // 2. å¸¸é‡
    bytes32 public constant UMBRELLA = 'UMBRELLA';
    
    // 3. ä¸å¯å˜å˜é‡
    IPoolAddressesProvider public immutable ADDRESSES_PROVIDER;
    
    // 4. çŠ¶æ€å˜é‡
    mapping(address => DataTypes.ReserveData) internal _reserves;
    
    // 5. ä¿®é¥°ç¬¦
    modifier onlyPoolConfigurator() {
        _onlyPoolConfigurator();
        _;
    }
    
    // 6. æ„é€ å‡½æ•°
    constructor(IPoolAddressesProvider provider) {
        ADDRESSES_PROVIDER = provider;
    }
    
    // 7. å¤–éƒ¨å‡½æ•°
    function supply(...) external virtual override {
        // ...
    }
    
    // 8. å…¬å…±å‡½æ•°
    function getReserveData(...) public view returns (...) {
        // ...
    }
    
    // 9. å†…éƒ¨å‡½æ•°
    function _onlyPoolConfigurator() internal view {
        // ...
    }
    
    // 10. ç§æœ‰å‡½æ•°
    function _privateFunction() private {
        // ...
    }
}
```

### åº“åˆçº¦æ¨¡å¼
```solidity
library SupplyLogic {
    using ReserveLogic for DataTypes.ReserveCache;
    using GPv2SafeERC20 for IERC20;
    
    function executeSupply(
        mapping(address => DataTypes.ReserveData) storage reservesData,
        mapping(uint256 => address) storage reservesList,
        DataTypes.UserConfigurationMap storage userConfig,
        DataTypes.ExecuteSupplyParams memory params
    ) external {
        // å®ç°é€»è¾‘
    }
}
```

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### è®¿é—®æ§åˆ¶
- **ä½¿ç”¨ä¿®é¥°ç¬¦**: æ‰€æœ‰éœ€è¦æƒé™çš„å‡½æ•°ä½¿ç”¨ `modifier`
- **å†…éƒ¨éªŒè¯å‡½æ•°**: å°†éªŒè¯é€»è¾‘æå–åˆ°å†…éƒ¨å‡½æ•°ï¼Œä¾¿äºé‡ç”¨

```solidity
modifier onlyPoolConfigurator() {
    _onlyPoolConfigurator();
    _;
}

function _onlyPoolConfigurator() internal view {
    require(
        ADDRESSES_PROVIDER.getPoolConfigurator() == _msgSender(),
        Errors.CallerNotPoolConfigurator()
    );
}
```

### è¾“å…¥éªŒè¯
- **ä½¿ç”¨ Errors åº“**: ç»Ÿä¸€é”™è¯¯å®šä¹‰ï¼ŒGas ä¼˜åŒ–
- **é›¶åœ°å€æ£€æŸ¥**: æ„é€ å‡½æ•°å’Œå…³é”®å‡½æ•°ä¸­æ£€æŸ¥é›¶åœ°å€
- **ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯**: æ›¿ä»£å­—ç¬¦ä¸²é”™è¯¯ï¼ˆGas ä¼˜åŒ–ï¼‰

```solidity
import {Errors} from '../helpers/Errors.sol';

constructor(IPoolAddressesProvider provider) {
    require(address(provider) != address(0), Errors.ZeroAddressNotValid());
    ADDRESSES_PROVIDER = provider;
}
```

### é‡å…¥æ”»å‡»é˜²æŠ¤
- **Checks-Effects-Interactions**: å…ˆæ£€æŸ¥ï¼Œå†æ›´æ–°çŠ¶æ€ï¼Œæœ€åå¤–éƒ¨è°ƒç”¨
- **é¿å…å¾ªç¯ä¸­çš„å¤–éƒ¨è°ƒç”¨**: å¯èƒ½å¯¼è‡´ Gas è€—å°½

```solidity
// âœ… æ­£ç¡®é¡ºåº
function withdraw(uint256 amount) external {
    // 1. Checks
    require(balance >= amount, Errors.InsufficientBalance());
    
    // 2. Effects
    balances[msg.sender] -= amount;
    
    // 3. Interactions
```

Interactions
    IERC20(token).transfer(msg.sender, amount);
}
```

### ç²¾åº¦å’Œæ•°å­¦è¿ç®—
- **ä½¿ç”¨ WadRayMath**: æ‰€æœ‰ç²¾åº¦è®¡ç®—ä½¿ç”¨ `WadRayMath` åº“
- **ä½¿ç”¨ SafeCast**: ç±»å‹è½¬æ¢æ—¶ä½¿ç”¨ OpenZeppelin çš„ `SafeCast`

```solidity
using WadRayMath for uint256;
using SafeCast for uint256;

uint256 result = principal.rayMul(rate);  // ä½¿ç”¨ rayMul è¿›è¡Œç²¾ç¡®è®¡ç®—
uint128 scaledAmount = amount.toUint128();  // ä½¿ç”¨ SafeCast è¿›è¡Œç±»å‹è½¬æ¢
```

### Gas ä¼˜åŒ–
- **Storage ç¼“å­˜**: å‡å°‘ SLOAD æ“ä½œ
- **Immutable å˜é‡**: æ„é€ å‡½æ•°å‚æ•°ä½¿ç”¨ `immutable`
- **Unchecked å—**: å¯¹å·²çŸ¥å®‰å…¨çš„ç®—æœ¯è¿ç®—ä½¿ç”¨ `unchecked`

```solidity
// Storage ç¼“å­˜ç¤ºä¾‹
DataTypes.ReserveCache memory reserveCache = reserve.cache();  // ç¼“å­˜ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨
reserveCache.updateState();
reserveCache.updateInterestRates();
```

### ç²¾åº¦å’Œæ•°å­¦è¿ç®—
- **ä½¿ç”¨ WadRayMath**: æ‰€æœ‰ç²¾åº¦è®¡ç®—ä½¿ç”¨ `WadRayMath` åº“
- **ä½¿ç”¨ SafeCast**: ç±»å‹è½¬æ¢æ—¶ä½¿ç”¨ OpenZeppelin çš„ `SafeCast`

```solidity
using WadRayMath for uint256;
using SafeCast for uint256;

uint256 result = principal.rayMul(rate);  // ä½¿ç”¨ rayMul è¿›è¡Œç²¾ç¡®è®¡ç®—
uint128 scaledAmount = amount.toUint128();  // ä½¿ç”¨ SafeCast è¿›è¡Œç±»å‹è½¬æ¢
```

---

## ğŸ“ ä»£ç ç»„ç»‡

### ç›®å½•ç»“æ„
```
src/contracts/
â”œâ”€â”€ dependencies/          # å¤–éƒ¨ä¾èµ–ï¼ˆOpenZeppelin, Gnosis ç­‰ï¼‰
â”œâ”€â”€ interfaces/           # æ¥å£å®šä¹‰ï¼ˆI å¼€å¤´ï¼‰
â”œâ”€â”€ protocol/             # æ ¸å¿ƒåè®®é€»è¾‘
â”‚   â”œâ”€â”€ pool/            # Pool åˆçº¦
â”‚   â”œâ”€â”€ libraries/       # åº“å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ logic/       # ä¸šåŠ¡é€»è¾‘åº“ï¼ˆSupplyLogic, BorrowLogic ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ math/        # æ•°å­¦åº“ï¼ˆWadRayMath, PercentageMathï¼‰
â”‚   â”‚   â”œâ”€â”€ configuration/ # é…ç½®åº“ï¼ˆReserveConfigurationï¼‰
â”‚   â”‚   â””â”€â”€ helpers/     # è¾…åŠ©åº“ï¼ˆErrors, TokenMathï¼‰
â”‚   â”œâ”€â”€ tokenization/    # Token åŒ–åˆçº¦ï¼ˆAToken, DebtTokenï¼‰
â”‚   â””â”€â”€ configuration/   # é…ç½®åˆçº¦ï¼ˆPoolAddressesProvider, ACLManagerï¼‰
â”œâ”€â”€ misc/                # å…¶ä»–åˆçº¦ï¼ˆOracle, Upgradeabilityï¼‰
â”œâ”€â”€ helpers/             # è¾…åŠ©åˆçº¦ï¼ˆWrappedTokenGatewayï¼‰
â”œâ”€â”€ rewards/             # å¥–åŠ±ç›¸å…³åˆçº¦
â”œâ”€â”€ treasury/            # èµ„é‡‘åº“åˆçº¦
â””â”€â”€ extensions/          # æ‰©å±•åŠŸèƒ½
    â”œâ”€â”€ stata-token/     # Stata Token
    â””â”€â”€ v3-config-engine/ # é…ç½®å¼•æ“
```

### æ–‡ä»¶å‘½åè§„èŒƒ
- **åˆçº¦æ–‡ä»¶**: `PascalCase.sol` (å¦‚ `Pool.sol`, `PoolStorage.sol`)
- **æ¥å£æ–‡ä»¶**: `I` + `PascalCase.sol` (å¦‚ `IPool.sol`, `IAToken.sol`)
- **åº“æ–‡ä»¶**: `PascalCase` + `Logic.sol` æˆ– `Math.sol` (å¦‚ `SupplyLogic.sol`, `WadRayMath.sol`)
- **æµ‹è¯•æ–‡ä»¶**: `ContractName.TestName.t.sol` (å¦‚ `Pool.Supply.t.sol`)

---

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### æµ‹è¯•æ–‡ä»¶ç»“æ„
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {Test} from 'forge-std/Test.sol';
import {ProtocolV3TestBase} from 'tests/utils/ProtocolV3TestBase.sol';
import {IPool} from 'src/contracts/interfaces/IPool.sol';

contract PoolSupplyTest is ProtocolV3TestBase {
    function setUp() public {
        _setUp();  // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
    }
    
    function test_Supply_Success() public {
        // æµ‹è¯•é€»è¾‘
    }
    
    function test_Supply_RevertWhen_InvalidAsset() public {
        vm.expectRevert(Errors.InvalidAsset());
        // æµ‹è¯•é€»è¾‘
    }
    
    function testFuzz_Supply(uint256 amount) public {
        amount = bound(amount, 1, type(uint128).max);
        // æ¨¡ç³Šæµ‹è¯•é€»è¾‘
    }
}
```

### æµ‹è¯•å‘½åè§„èŒƒ
- **æˆåŠŸæµ‹è¯•**: `test_FunctionName_Success()`
- **é”™è¯¯æµ‹è¯•**: `test_FunctionName_RevertWhen_Condition()`
- **æ¨¡ç³Šæµ‹è¯•**: `testFuzz_FunctionName(parameters)`
- **Gas æµ‹è¯•**: `test_Gas_FunctionName()`

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
forge test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
forge test --match-path tests/protocol/pool/Pool.Supply.t.sol

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
forge test --match-test test_Supply_Success

# è¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆæ›´å¤šè¿è¡Œæ¬¡æ•°ï¼‰
forge test --fuzz-runs 10000

# ç”Ÿæˆ Gas æŠ¥å‘Š
forge test --gas-report

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
forge test -vvvv
```


## ğŸ‘¥ å›¢é˜Ÿåä½œè§„èŒƒ

### Git å·¥ä½œæµ
- **åˆ†æ”¯ç­–ç•¥**:
  - `main`: ä¸»åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬
  - `develop`: å¼€å‘åˆ†æ”¯
  - `feature/*`: åŠŸèƒ½åˆ†æ”¯
  - `fix/*`: ä¿®å¤åˆ†æ”¯
  - `test/*`: æµ‹è¯•ç›¸å…³åˆ†æ”¯

### æäº¤ä¿¡æ¯è§„èŒƒ
éµå¾ª Conventional Commits:
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**: `feat`, `fix`, `docs`, `test`, `refactor`, `chore`, `perf`, `style`

**Scope**: `pool`, `oracle`, `access-control`, `test`, `config`, `library`

**ç¤ºä¾‹**:
```
feat(pool): add KYC check in supply function

Add KYC verification before allowing users to supply assets.

Closes #123
```

### æäº¤å‰æ£€æŸ¥
- [ ] ä»£ç é€šè¿‡ `forge build`
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ `forge test`
- [ ] ä»£ç æ ¼å¼åŒ–é€šè¿‡ `forge fmt --check`
- [ ] æ²¡æœ‰å¼•å…¥æ–°çš„å®‰å…¨æ¼æ´

### ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡è¶³å¤Ÿ
- [ ] æ²¡æœ‰å®‰å…¨æ¼æ´
- [ ] äº‹ä»¶å·²æ­£ç¡®æ·»åŠ 
- [ ] Gas ä¼˜åŒ–å·²è€ƒè™‘
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## âš ï¸ å¸¸è§é”™è¯¯é¿å…

1. **ä¸è¦ç›´æ¥ä¿®æ”¹å­˜å‚¨å¸ƒå±€** - å½±å“åˆçº¦å‡çº§
2. **ä¸è¦å¿½ç•¥è®¿é—®æ§åˆ¶** - æ‰€æœ‰å…³é”®å‡½æ•°å¿…é¡»æœ‰æƒé™æ£€æŸ¥
3. **ä¸è¦å¿˜è®°äº‹ä»¶** - æ‰€æœ‰çŠ¶æ€å˜æ›´åº” emit äº‹ä»¶
4. **ä¸è¦ç¡¬ç¼–ç åœ°å€** - ä½¿ç”¨é…ç½®åˆçº¦æˆ–å‚æ•°
5. **ä¸è¦å¿½ç•¥ç²¾åº¦** - ä½¿ç”¨æ•°å­¦åº“è¿›è¡Œç²¾ç¡®è®¡ç®—
6. **ä¸è¦è·³è¿‡æµ‹è¯•** - æ¯ä¸ªåŠŸèƒ½éƒ½éœ€è¦æµ‹è¯•è¦†ç›–
7. **ä¸è¦å¿½ç•¥ Gas ä¼˜åŒ–** - è€ƒè™‘ Gas æˆæœ¬
8. **ä¸è¦å¿˜è®°å¤šé“¾å…¼å®¹æ€§** - æµ‹è¯•ä¸åŒé“¾çš„ç‰¹æ€§
9. **ä¸è¦ä½¿ç”¨ `tx.origin`** - ä½¿ç”¨ `msg.sender`
10. **ä¸è¦åœ¨å¾ªç¯ä¸­æ‰§è¡Œå¤–éƒ¨è°ƒç”¨** - å¯èƒ½å¯¼è‡´ Gas è€—å°½

---

## ğŸ“š å‚è€ƒèµ„æº

### é¡¹ç›®ç»“æ„
- **æ ¸å¿ƒåè®®**: `src/contracts/protocol/`
- **æ¥å£å®šä¹‰**: `src/contracts/interfaces/`
- **åº“å‡½æ•°**: `src/contracts/protocol/libraries/`
- **æµ‹è¯•æ–‡ä»¶**: `tests/`

### å¤–éƒ¨èµ„æº
- **Foundry æ–‡æ¡£**: https://book.getfoundry.sh/
- **Aave æ–‡æ¡£**: https://docs.aave.com/
- **Solidity æ–‡æ¡£**: https://docs.soliditylang.org/
- **OpenZeppelin**: https://docs.openzeppelin.com/
